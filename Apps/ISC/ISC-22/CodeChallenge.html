<!DOCTYPE HTML>
<html lang="cn" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Code Challenge - GeekPie_HPC Wiki</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">Summary</li><li class="chapter-item expanded "><a href="../../../index.html"><strong aria-hidden="true">1.</strong> Intro</a></li><li class="chapter-item expanded "><a href="../../../Algorithm/index.html"><strong aria-hidden="true">2.</strong> Algorithm</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Algorithm/dgemm.html"><strong aria-hidden="true">2.1.</strong> dgemm</a></li><li class="chapter-item expanded "><a href="../../../Algorithm/fft.html"><strong aria-hidden="true">2.2.</strong> fft</a></li><li class="chapter-item expanded "><a href="../../../Algorithm/kmer.html"><strong aria-hidden="true">2.3.</strong> Kmer</a></li></ol></li><li class="chapter-item expanded "><a href="../../../Apps/index.html"><strong aria-hidden="true">3.</strong> Apps</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Apps/ASC/index.html"><strong aria-hidden="true">3.1.</strong> ASC</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Apps/ASC/asc-19/index.html"><strong aria-hidden="true">3.1.1.</strong> Asc 19</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Apps/ASC/asc-19/cesm.html"><strong aria-hidden="true">3.1.1.1.</strong> Cesm</a></li></ol></li><li class="chapter-item expanded "><a href="../../../Apps/ASC/asc-20/index.html"><strong aria-hidden="true">3.1.2.</strong> Asc 20-21</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Apps/ASC/asc-20/quest.html"><strong aria-hidden="true">3.1.2.1.</strong> Quest</a></li></ol></li><li class="chapter-item expanded "><a href="../../../Apps/ASC/asc-22/index.html"><strong aria-hidden="true">3.1.3.</strong> Asc 22</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Apps/ASC/asc-22/yuan.html"><strong aria-hidden="true">3.1.3.1.</strong> yuan</a></li><li class="chapter-item expanded "><a href="../../../Apps/ASC/asc-22/DeepMD.html"><strong aria-hidden="true">3.1.3.2.</strong> DeepMD</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../Apps/ISC/index.html"><strong aria-hidden="true">3.2.</strong> ISC</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Apps/ISC/ISC-21/index.html"><strong aria-hidden="true">3.2.1.</strong> ISC 21</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Apps/ISC/ISC-21/CodeChallenge.html"><strong aria-hidden="true">3.2.1.1.</strong> Code Challenge</a></li><li class="chapter-item expanded "><a href="../../../Apps/ISC/ISC-21/LAMMPS.html"><strong aria-hidden="true">3.2.1.2.</strong> LAMMPS</a></li><li class="chapter-item expanded "><a href="../../../Apps/ISC/ISC-21/GPAW.html"><strong aria-hidden="true">3.2.1.3.</strong> GPAW</a></li><li class="chapter-item expanded "><a href="../../../Apps/ISC/ISC-21/MHM2.html"><strong aria-hidden="true">3.2.1.4.</strong> MHM2</a></li><li class="chapter-item expanded "><a href="../../../Apps/ISC/ISC-21/WRF.html"><strong aria-hidden="true">3.2.1.5.</strong> WRF</a></li></ol></li><li class="chapter-item expanded "><a href="../../../Apps/ISC/ISC-22/index.html"><strong aria-hidden="true">3.2.2.</strong> ISC 22</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Apps/ISC/ISC-22/CodeChallenge.html" class="active"><strong aria-hidden="true">3.2.2.1.</strong> Code Challenge</a></li><li class="chapter-item expanded "><a href="../../../Apps/ISC/ISC-22/Incompact3D.html"><strong aria-hidden="true">3.2.2.2.</strong> Incompact3D</a></li><li class="chapter-item expanded "><a href="../../../Apps/ISC/ISC-22/NWChem.html"><strong aria-hidden="true">3.2.2.3.</strong> NWChem</a></li><li class="chapter-item expanded "><a href="../../../Apps/ISC/ISC-22/ICON.html"><strong aria-hidden="true">3.2.2.4.</strong> ICON</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../Apps/SC/index.html"><strong aria-hidden="true">3.3.</strong> SC</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Apps/SC/SC21/index.html"><strong aria-hidden="true">3.3.1.</strong> SC 21</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Apps/SC/SC21/quantum-espresso.html"><strong aria-hidden="true">3.3.1.1.</strong> Quantum Espresso</a></li><li class="chapter-item expanded "><a href="../../../Apps/SC/SC21/ramBLe.html"><strong aria-hidden="true">3.3.1.2.</strong> Ram B Le</a></li><li class="chapter-item expanded "><a href="../../../Apps/SC/SC21/cardioid.html"><strong aria-hidden="true">3.3.1.3.</strong> Cardioid</a></li><li class="chapter-item expanded "><a href="../../../Apps/SC/SC21/Mystery.html"><strong aria-hidden="true">3.3.1.4.</strong> Mystery</a></li></ol></li><li class="chapter-item expanded "><a href="../../../Apps/SC/SC20.html"><strong aria-hidden="true">3.3.2.</strong> SC 20</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../Benchmark/index.html"><strong aria-hidden="true">4.</strong> Benchmark</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Benchmark/hpcg-dat.html"><strong aria-hidden="true">4.1.</strong> Hpcg Dat</a></li><li class="chapter-item expanded "><a href="../../../Benchmark/hpl-dat.html"><strong aria-hidden="true">4.2.</strong> Hpl Dat</a></li><li class="chapter-item expanded "><a href="../../../Benchmark/io500.html"><strong aria-hidden="true">4.3.</strong> Io 500</a></li></ol></li><li class="chapter-item expanded "><a href="../../../DevOps/index.html"><strong aria-hidden="true">5.</strong> Dev Ops</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../DevOps/beegfs.html"><strong aria-hidden="true">5.1.</strong> BeeGFS</a></li><li class="chapter-item expanded "><a href="../../../DevOps/Grafana.html"><strong aria-hidden="true">5.2.</strong> Grafana</a></li><li class="chapter-item expanded "><a href="../../../DevOps/LDAP.html"><strong aria-hidden="true">5.3.</strong> LDAP</a></li><li class="chapter-item expanded "><a href="../../../DevOps/SaltStack.html"><strong aria-hidden="true">5.4.</strong> Salt Stack</a></li><li class="chapter-item expanded "><a href="../../../DevOps/Scheduler.html"><strong aria-hidden="true">5.5.</strong> Scheduler</a></li><li class="chapter-item expanded "><a href="../../../DevOps/Singularity.html"><strong aria-hidden="true">5.6.</strong> Singularity</a></li></ol></li><li class="chapter-item expanded "><a href="../../../Language/index.html"><strong aria-hidden="true">6.</strong> Language</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Language/C++.html"><strong aria-hidden="true">6.1.</strong> C++</a></li><li class="chapter-item expanded "><a href="../../../Language/Chisel.html"><strong aria-hidden="true">6.2.</strong> Chisel</a></li><li class="chapter-item expanded "><a href="../../../Language/Fortran.html"><strong aria-hidden="true">6.3.</strong> Fortran</a></li><li class="chapter-item expanded "><a href="../../../Language/Go.html"><strong aria-hidden="true">6.4.</strong> Go</a></li><li class="chapter-item expanded "><a href="../../../Language/Rust.html"><strong aria-hidden="true">6.5.</strong> Rust</a></li></ol></li><li class="chapter-item expanded "><a href="../../../Libs/index.html"><strong aria-hidden="true">7.</strong> Libs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Libs/Svml.html"><strong aria-hidden="true">7.1.</strong> Svml</a></li><li class="chapter-item expanded "><a href="../../../Libs/NumaCTL.html"><strong aria-hidden="true">7.2.</strong> NumaCTL</a></li><li class="chapter-item expanded "><a href="../../../Libs/Boost.html"><strong aria-hidden="true">7.3.</strong> Boost</a></li></ol></li><li class="chapter-item expanded "><a href="../../../Profiling/index.html"><strong aria-hidden="true">8.</strong> Profiling</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Profiling/ArmForge.html"><strong aria-hidden="true">8.1.</strong> Arm Forge</a></li><li class="chapter-item expanded "><a href="../../../Profiling/uProf.html"><strong aria-hidden="true">8.2.</strong> Uprof</a></li><li class="chapter-item expanded "><a href="../../../Profiling/Vtune.html"><strong aria-hidden="true">8.3.</strong> Vtune</a></li></ol></li><li class="chapter-item expanded "><a href="../../../Spack/handson.html"><strong aria-hidden="true">9.</strong> Spack</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Spack/package.html"><strong aria-hidden="true">9.1.</strong> package</a></li><li class="chapter-item expanded "><a href="../../../Spack/handson.html"><strong aria-hidden="true">9.2.</strong> handson</a></li><li class="chapter-item expanded "><a href="../../../Spack/debug.html"><strong aria-hidden="true">9.3.</strong> debug</a></li></ol></li><li class="chapter-item expanded "><a href="../../../Sysadmin/index.html"><strong aria-hidden="true">10.</strong> Sysadmin</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Sysadmin/cluster-setup.html"><strong aria-hidden="true">10.1.</strong> Cluster Setup</a></li><li class="chapter-item expanded "><a href="../../../Sysadmin/environment-installation.html"><strong aria-hidden="true">10.2.</strong> Environment Installation</a></li><li class="chapter-item expanded "><a href="../../../Sysadmin/environment-modules.html"><strong aria-hidden="true">10.3.</strong> Environment Modules</a></li><li class="chapter-item expanded "><a href="../../../Sysadmin/it-support-machine.html"><strong aria-hidden="true">10.4.</strong> It-Support Machine</a></li><li class="chapter-item expanded "><a href="../../../Sysadmin/bmc-reverse.html"><strong aria-hidden="true">10.5.</strong> BMC Reverse</a></li><li class="chapter-item expanded "><a href="../../../Sysadmin/Oracle/index.html"><strong aria-hidden="true">10.6.</strong> Oracle</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Sysadmin/Oracle/ansible.html"><strong aria-hidden="true">10.6.1.</strong> Ansible</a></li><li class="chapter-item expanded "><a href="../../../Sysadmin/Oracle/grafana.html"><strong aria-hidden="true">10.6.2.</strong> Grafana</a></li></ol></li><li class="chapter-item expanded "><a href="../../../Sysadmin/ISC/index.html"><strong aria-hidden="true">10.7.</strong> ISC</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Sysadmin/ISC/NSCC.html"><strong aria-hidden="true">10.7.1.</strong> NSCC</a></li><li class="chapter-item expanded "><a href="../../../Sysadmin/ISC/Bridges.html"><strong aria-hidden="true">10.7.2.</strong> Bridges</a></li><li class="chapter-item expanded "><a href="../../../Sysadmin/ISC/Thor.html"><strong aria-hidden="true">10.7.3.</strong> Thor</a></li><li class="chapter-item expanded "><a href="../../../Sysadmin/ISC/Niagara.html"><strong aria-hidden="true">10.7.4.</strong> Niagara</a></li></ol></li><li class="chapter-item expanded "><a href="../../../Sysadmin/Azure/index.html"><strong aria-hidden="true">10.8.</strong> Azure</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Sysadmin/Azure/cyclecloud.html"><strong aria-hidden="true">10.8.1.</strong> CycleCloud</a></li><li class="chapter-item expanded "><a href="../../../Sysadmin/Azure/check-list.html"><strong aria-hidden="true">10.8.2.</strong> Check List</a></li></ol></li><li class="chapter-item expanded "><a href="../../../Sysadmin/GeekPie/index.html"><strong aria-hidden="true">10.9.</strong> GeekPie</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Sysadmin/GeekPie/hardware.html"><strong aria-hidden="true">10.9.1.</strong> Hardware</a></li><li class="chapter-item expanded "><a href="../../../Sysadmin/GeekPie/software.html"><strong aria-hidden="true">10.9.2.</strong> Software</a></li><li class="chapter-item expanded "><a href="../../../Sysadmin/GeekPie/tuning.html"><strong aria-hidden="true">10.9.3.</strong> Tuning</a></li><li class="chapter-item expanded "><a href="../../../Sysadmin/GeekPie/kernel.html"><strong aria-hidden="true">10.9.4.</strong> Kernel</a></li><li class="chapter-item expanded "><a href="../../../Sysadmin/GeekPie/systemd-nspawn.html"><strong aria-hidden="true">10.9.5.</strong> systemd-nspawn</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../../Architecture/index.html"><strong aria-hidden="true">11.</strong> Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../Architecture/MemoryModel.html"><strong aria-hidden="true">11.1.</strong> Memory Model</a></li><li class="chapter-item expanded "><a href="../../../Architecture/SVE.html"><strong aria-hidden="true">11.2.</strong> SVE</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">GeekPie_HPC Wiki</h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/geekpiehpc/wiki" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="code-challenge-for-isc22"><a class="header" href="#code-challenge-for-isc22">Code Challenge for ISC22</a></h1>
<h1 id="how-do-we-improve-the-performance-of-incompact3d"><a class="header" href="#how-do-we-improve-the-performance-of-incompact3d">How do we improve the performance of Incompact3d</a></h1>
<p>Jiajun Cheng Optimizing &amp; profiling, Zike Xu Deploying &amp; Compiling</p>
<h1 id="code-optimization"><a class="header" href="#code-optimization">Code optimization</a></h1>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC53.png" alt="" /></p>
<p>Make it non-blocking</p>
<p>By supplanting the blocking MPI calls to non-blocking MPI calls, we can do multiple AllReduce in parallel.</p>
<p>Non-blocking MPI calls enable Mvapich2-DPU to offload data to DPU.</p>
<p>If there are heavy computations, between the IAllReduce and Wait, we can save a lot of time.</p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC54.png" alt="" /></p>
<p>Make it non-blocking</p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC55.png" alt="" /></p>
<p>By supplanting the blocking MPI calls to non-blocking MPI calls, we can do multiple AllReduce in parallel.</p>
<p>Non-blocking MPI calls enable Mvapich2-DPU to offload data to DPU.</p>
<p>This is an example that there are computations between transpose_start and transpose_wait.</p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC56.png" alt="" /></p>
<p>Make it non-blocking in detail</p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC57.png" alt="" /></p>
<p>We removed the dependency relationship between Incompact3d and Libnbc.</p>
<p>We did some Api conversions. For example, we replace NBC_IALLTOALL with MPI_IALLTOALL and NBC_WAIT to MPI_WAIT.</p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC58.png" alt="" /></p>
<p>Code optimization</p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC59.png" alt="" /></p>
<p>Make it non-blocking in detail</p>
<p>We must keep the buffer that we passed into the transpose_start unchanged during the non-blocking call. Therefore, we need buffers.</p>
<p>To make a prototype, we simply increase the number of buffers. We can make a buffer pool when we have more time.</p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC60.png" alt="" /></p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC61.png" alt="" /></p>
<p>Make it non-blocking in detail</p>
<p>The key concept of making a blocking process into a non-blocking process is to calculate the data dependency relationship between variables, i.e., to trace the data flow.</p>
<p>The variable relationship is shown in the figure. We can see that we can calculate these arrays in parallel.</p>
<p>Make it non-blocking in detail</p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC63.png" alt="" /></p>
<p>When the dataflow becomes complex, adapting the code to be non-blocking can be a nightmare. It is hard for human to trace the dataflow.</p>
<p>We think that compilers can handle this. By analyzing the AST, the compiler knows the dependencies between the variables. It can automatically turn blocking MPI calls into non-blocking MPI calls base on the dependency relationship.</p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC64.png" alt="" /></p>
<p>Make it non-blocking in detail</p>
<p>However, the optimizations that done by analyzing dataflow are limited, the figure shows an tough circumstance which can hardly optimized by analyzing dataflow.</p>
<p>The variables rely on each other very closely. When we get the data from the MPI calls, we immediately use the data. Therefore, there is no point changing the blocking MPI calls into non-blocking ones.</p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC65.png" alt="" /></p>
<p>Make it faster</p>
<p>After we convert the blocking MPI calls into non-blocking MPI calls, we acquire an performance improvement around 6%, even without DPU offloading.</p>
<p>We noticed that a lot of MPI_Alltoallv are replaced by MPI_IalltoallV and MPI_Wait.</p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC66.png" alt="" /></p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC67.png" alt="" /></p>
<p>Make it faster</p>
<p>After we profiling the application, we found a hotspot.</p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC68.png" alt="" /></p>
<p>Code optimization</p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC69.png" alt="" /></p>
<p>Make it faster</p>
<p>The compiler fails to vectorize the calculation, and we help the compiler to optimize the code.</p>
<p>We inline the function sqrt_prec manually.</p>
<p>We use where statement and matrix operations, instead of manipulate the array element one by one.</p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC70.png" alt="" /></p>
<p>Code optimization</p>
<p>Make it faster</p>
<p>Finally, we get a performance improvement around 40%.</p>
<p>The test data is based on the Xcompact3d for ISC22, not Code challenge.</p>
<h1 id="dpu-offload"><a class="header" href="#dpu-offload">DPU offload</a></h1>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC71.png" alt="" /></p>
<p>When the message size is between 16KB and 512KB, the MPI will perform a DPU offload.</p>
<p>When the message size is less than 8KB or more than 1MB, the MPI will not perform a DPU offload.</p>
<p>The overlapping can cover the cost of MPI communication.</p>
<p>Mvapich2-DPU only supports offloading non-blocking MPI calls to DPU.</p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC72.png" alt="" /></p>
<p>In our case, the speed up is not so obvious.</p>
<p>Compare to the command line output in the last slide which shows the result of using DPU offloading, the overlap decrease significantly.</p>
<p>However, the wallclock between two modes with DPU offloading and without DPU offloading are very close.</p>
<p>Different buffer size</p>
<table><thead><tr><th style="text-align: center">PPN / Buffer Size / Kind</th><th style="text-align: center">Alltoallv</th><th style="text-align: center">Ialltoallv</th><th style="text-align: center">Allreduce</th><th style="text-align: center">Reduce</th><th style="text-align: center">Iallreduce</th></tr></thead><tbody>
<tr><td style="text-align: center">4</td><td style="text-align: center">1M/512K</td><td style="text-align: center">1M/512K</td><td style="text-align: center">8</td><td style="text-align: center">8</td><td style="text-align: center">/</td></tr>
<tr><td style="text-align: center">8</td><td style="text-align: center">256K</td><td style="text-align: center">256K</td><td style="text-align: center">8</td><td style="text-align: center">8</td><td style="text-align: center">2K</td></tr>
<tr><td style="text-align: center">16</td><td style="text-align: center">128K/64K</td><td style="text-align: center">128K/64K</td><td style="text-align: center">8</td><td style="text-align: center">8</td><td style="text-align: center">2K</td></tr>
<tr><td style="text-align: center">32</td><td style="text-align: center">32K</td><td style="text-align: center">32K</td><td style="text-align: center">8</td><td style="text-align: center">8</td><td style="text-align: center">2K</td></tr>
</tbody></table>
<p>With the increase of PPN, we buffer size of Alltoallv and Ialltoallv becomes smaller and smaller.</p>
<p>We except when PPN is 8, 16, and 32, DPU offloading will make an effect, and a higher performance will be acquired.</p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC73.png" alt="" /></p>
<p>However, the performance remains the same even though we enable the DPU offloading.</p>
<p>The upper image is DPU offloading disabled.</p>
<p>The other image is DPU offloading enabled.</p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC74.png" alt="" /></p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC75.png" alt="" /></p>
<p>However, the performance remains the same even though we enable the DPU offloading.</p>
<p>The upper image is DPU offloading disabled.</p>
<p>The other image is DPU offloading enabled.</p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC76.png" alt="" /></p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC77.png" alt="" /></p>
<p>However, the performance remains the same even though we enable the DPU offloading.</p>
<p>The upper image is DPU offloading disabled.</p>
<p>The other image is DPU offloading enabled.</p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC78.png" alt="" /></p>
<h1 id="possible-reasons"><a class="header" href="#possible-reasons">Possible reasons</a></h1>
<p>MVAPICH2 implements job balance between blocking MPI calls and non-blocking MPI calls quite well. DPU is unnecessary in this circumstance.</p>
<p>The topology of Thor cluster has some issues.</p>
<p>We do not use the correct network device.</p>
<p>We configured the runtime wrongly which is the least possible, since we get the reasonable overlapping result from the OSU MPI Non-blocking All-to-All Latency Test.</p>
<h1 id="weak-scalability"><a class="header" href="#weak-scalability">Weak Scalability</a></h1>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC79.png" alt="" /></p>
<p>We keep every process handle the same amount of data.</p>
<p>For example, the nx, ny, and nz for PPN=8 is 323. The nx, ny, and nz for PPN=16 is 512.</p>
<p>512*512*512/256 = 524,288</p>
<p>323*323*323/64=526,535</p>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC80.png" alt="" /></p>
<p>Different buffer size</p>
<table><thead><tr><th style="text-align: center">PPN / Buffer Size / Kind</th><th style="text-align: center">Alltoallv</th><th style="text-align: center">Ialltoallv</th><th style="text-align: center">Allreduce</th><th style="text-align: center">Reduce</th></tr></thead><tbody>
<tr><td style="text-align: center">8</td><td style="text-align: center">428K/512K</td><td style="text-align: center">428K/512K</td><td style="text-align: center">8</td><td style="text-align: center">8</td></tr>
<tr><td style="text-align: center">32</td><td style="text-align: center">1M</td><td style="text-align: center">1M</td><td style="text-align: center">8</td><td style="text-align: center">8</td></tr>
</tbody></table>
<p>With the increase of PPN, we buffer size of Alltoallv and Ialltoallv becomes larger.</p>
<p>It seems that the buffer is larger than 512K, so DPU offloading may not make a difference.</p>
<p>Different performance</p>
<p>We keep every process handle the same amount of data.</p>
<p>With the increase of PPN and the problem size, we find that the time increase significantly.</p>
<h1 id="strong-scalability"><a class="header" href="#strong-scalability">Strong Scalability</a></h1>
<p>Different performance</p>
<p>We keep every process handle the same amount of data.</p>
<p>With the increase of PPN and keep the problem size unchanged, we find a pretty good strong scalability.</p>
<p>We do not successfully submit the job 8x8 ppn8 with DPU, so we use the data 8x8 ppn8 without DPU instead.</p>
<h1 id="difficulties"><a class="header" href="#difficulties">Difficulties</a></h1>
<ul>
<li>We failed to pass environment variables such as IPM_LOG=full to Xcompact3d, so we change the source code of IPM and set the log level manually.</li>
<li>The Makefile of Xcompact3d is not well written. We cannot compile successfully when the make job count is greater than 1. Therefore, we wrote CMakeLists.txt and use Cmake to compile the project.</li>
<li>When we use FFTW3 as FFT backend, the FFTW3LibraryDepends.cmake is missing, which is required by FFTW3Config.cmake. This issue has been existed for 4 years, which still has not been solved see <a href="https://github.com/FFTW/fftw3/issues/130">https://github.com/FFTW/fftw3/issues/130</a>.
<ul>
<li>We removed the dependency relationship between FFTW3Config.cmake and FFTW3LibraryDepends.cmake.</li>
<li>We will make a pull request to fix the problem as soon as possible.</li>
</ul>
</li>
</ul>
<h1 id="lessons-learned"><a class="header" href="#lessons-learned">Lessons learned</a></h1>
<ul>
<li>Submit jobs as early as possible
<ul>
<li>Thanks David, he enable us to complete all the jobs.</li>
</ul>
</li>
<li>Use build system like Spack can improve application performance and save time
<ul>
<li>We can switch between different FFT implementations by configs.</li>
<li>We only meet a little compile problem with the help of Spack.</li>
<li>Making custom Spack package is easy What we write is actually a DSL.</li>
</ul>
</li>
<li>Non-blocking calls can make better use of system resource
<ul>
<li>This concept has been widely used, like the “async” keyword in programming languages, non-blocking MPI calls and message queue.</li>
</ul>
</li>
</ul>
<p><img src="img/ISC22-Final-Report-ShanghaiTech-GeekPie_HPC81.png" alt="" /></p>
<h1 id="innovation"><a class="header" href="#innovation">Innovation</a></h1>
<ul>
<li>Describe an application that you took and can demonstrate innovation work upon
<ul>
<li>Using Intel MPI and Intel® Trace Analyzer and Collector to improve MPI Profiling.</li>
<li>Using Arm Forge to Find Hotspots in Code level.</li>
<li>Analyzing the FP ALU usage to diagnose the degree of vectorization.</li>
<li>Changing blocking MPI calls into non-blocking MPI calls in Xcompact3d.</li>
<li>Using Spack as the build system during the competition.</li>
<li>Putting forward the idea of changing the blocking MPI calls into non-blocking MPI automatically by compilers.</li>
<li>Discussing the weak scalability and strong scalability about Xcompact3d.</li>
</ul>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../Apps/ISC/ISC-22/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../../Apps/ISC/ISC-22/Incompact3D.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../Apps/ISC/ISC-22/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../../Apps/ISC/ISC-22/Incompact3D.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
