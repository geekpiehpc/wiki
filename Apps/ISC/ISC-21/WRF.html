
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>WRF Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../../gitbook/images/favicon.ico" type="image/x-icon">

    
    
    <link rel="prev" href="CodeChallenge.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../../">
            
                <a href="../../../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../../../Algorithm/">
            
                <a href="../../../Algorithm/">
            
                    
                    Algorithm
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../../../Algorithm/dgemm.html">
            
                <a href="../../../Algorithm/dgemm.html">
            
                    
                    Dgemm
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../../../Algorithm/kmer.html">
            
                <a href="../../../Algorithm/kmer.html">
            
                    
                    Kmer
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../../">
            
                <a href="../../">
            
                    
                    Apps
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" >
            
                <span>
            
                    
                    ASC
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1.1" >
            
                <span>
            
                    
                    Asc 19
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1.1.1" data-path="../../ASC/asc-19/cesm.html">
            
                <a href="../../ASC/asc-19/cesm.html">
            
                    
                    Cesm
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.1.2" >
            
                <span>
            
                    
                    Asc 20
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1.2.1" data-path="../../ASC/asc-20/quest.html">
            
                <a href="../../ASC/asc-20/quest.html">
            
                    
                    Quest
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../">
            
                <a href="../">
            
                    
                    ISC
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.1" data-path="./">
            
                <a href="./">
            
                    
                    ISC 21
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.1.1" data-path="CodeChallenge.html">
            
                <a href="CodeChallenge.html">
            
                    
                    Code Challenge
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.3.2.1.2" data-path="WRF.html">
            
                <a href="WRF.html">
            
                    
                    WRF
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.3" >
            
                <span>
            
                    
                    SC
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.3.1" >
            
                <span>
            
                    
                    SC 21
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.3.1.1" data-path="../../SC/SC21/ramBLe.html">
            
                <a href="../../SC/SC21/ramBLe.html">
            
                    
                    Ram B Le
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.3.2" data-path="../../SC/SC20.html">
            
                <a href="../../SC/SC20.html">
            
                    
                    SC 20
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../../../Benchmark/">
            
                <a href="../../../Benchmark/">
            
                    
                    Benchmark
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../../../Benchmark/hpcg-dat.html">
            
                <a href="../../../Benchmark/hpcg-dat.html">
            
                    
                    Hpcg Dat
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../../../Benchmark/hpl-dat.html">
            
                <a href="../../../Benchmark/hpl-dat.html">
            
                    
                    Hpl Dat
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../../../DevOps/">
            
                <a href="../../../DevOps/">
            
                    
                    Dev Ops
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../../../DevOps/LDAP.html">
            
                <a href="../../../DevOps/LDAP.html">
            
                    
                    LDAP
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../../../DevOps/Schduler.html">
            
                <a href="../../../DevOps/Schduler.html">
            
                    
                    Schduler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../../../DevOps/Singularity.html">
            
                <a href="../../../DevOps/Singularity.html">
            
                    
                    Singularity
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../../../Language/">
            
                <a href="../../../Language/">
            
                    
                    Language
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../../../Language/Chisel.html">
            
                <a href="../../../Language/Chisel.html">
            
                    
                    Chisel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../../../Language/Go.html">
            
                <a href="../../../Language/Go.html">
            
                    
                    Go
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../../../Language/Rust.html">
            
                <a href="../../../Language/Rust.html">
            
                    
                    Rust
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../../../Libs/">
            
                <a href="../../../Libs/">
            
                    
                    Libs
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../../../Libs/Boost.html">
            
                <a href="../../../Libs/Boost.html">
            
                    
                    Boost
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" >
            
                <span>
            
                    
                    Profiling
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../../../Profiling/ArmForce.html">
            
                <a href="../../../Profiling/ArmForce.html">
            
                    
                    Arm Force
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../../../Profiling/Vtune.html">
            
                <a href="../../../Profiling/Vtune.html">
            
                    
                    Vtune
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" >
            
                <span>
            
                    
                    Sysadmin
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="../../../Sysadmin/cluster-setup.html">
            
                <a href="../../../Sysadmin/cluster-setup.html">
            
                    
                    Cluster Setup
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="../../../Sysadmin/environment-installation.html">
            
                <a href="../../../Sysadmin/environment-installation.html">
            
                    
                    Environment Installation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="../../../Sysadmin/environment-modules.html">
            
                <a href="../../../Sysadmin/environment-modules.html">
            
                    
                    Environment Modules
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.4" data-path="../../../Sysadmin/machine.html">
            
                <a href="../../../Sysadmin/machine.html">
            
                    
                    Machine
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../.." >WRF</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="wrf">WRF</h1>
<blockquote>
<p>&#x50BB;&#x903C;Fortran&#xFF0C;2021&#x5E74;&#x4E86;&#xFF0C;&#x5C45;&#x7136;&#x8FD8;&#x6709;&#x4EBA;&#x7528;Fortran&#xFF08;</p>
<p>&#x6700;&#x597D;&#x627E;&#x505A;&#x6C14;&#x8C61;&#x7684;&#x4EBA;&#x95EE;&#x95EE;&#x6709;&#x5173;&#x53C2;&#x6570;&#x8BBE;&#x7F6E;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x53EF;&#x60DC;&#x6211;&#x6CA1;&#x627E;&#x5230;</p>
</blockquote>
<p>&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x6709;&#x5173;&#x5730;&#x7403;&#x79D1;&#x5B66;&#x7684;&#x5929;&#x6C14;&#x6A21;&#x62DF;&#x7CFB;&#x7EDF;&#xFF0C;&#x6240;&#x6709;&#x6709;&#x5173;&#x5730;&#x7403;&#x79D1;&#x5B66;&#x548C;Fortran&#x5E76;&#x884C;&#x5316;&#x7684;&#x5176;&#x4ED6;&#x5E94;&#x7528;&#x90FD;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x4E00;&#x4E0B;</p>
<h2 id="task-links-and-introductions">Task links and introductions</h2>
<p><a href="https://hpcadvisorycouncil.atlassian.net/wiki/spaces/HPCWORKS/pages/1827438600/WRF+with+Single+Domain+-+Practice+case+for+ISC21+SCC" target="_blank">Practice case for ISC21 SCC</a></p>
<p><a href="https://hpcadvisorycouncil.atlassian.net/wiki/spaces/HPCWORKS/pages/1827438607/WRF+-+3+Domain+Problem+for+ISC21+SCC" target="_blank">3 Domain Problem for ISC21 SCC</a></p>
<h2 id="install">Install</h2>
<h3 id="required-libs">required libs</h3>
<p>HDF5, NetCDF-C, NetCDF-Fortran (&#x624B;&#x52A8;&#x5B89;&#x88C5;&#x53EF;&#x80FD;&#x66F4;&#x597D;&#xFF0C;&#x9700;&#x8981;mpi)</p>
<h4 id="hdf5">HDF5</h4>
<pre><code class="lang-bash">./configure --prefix=&#x4F60;&#x7684;&#x5B89;&#x88C5;&#x8DEF;&#x5F84;/hdf5 --enable-fortran --enable-fortran2003 --enable-parallel
make -j 48
make install
</code></pre>
<pre><code class="lang-bash"><span class="hljs-comment"># vi ~/.bashrc</span>
<span class="hljs-built_in">export</span> HDF5=&#x4F60;&#x7684;&#x5B89;&#x88C5;&#x8DEF;&#x5F84;/hdf5
<span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$HDF5</span>/bin:<span class="hljs-variable">$PATH</span>
<span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$HDF5</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span>
<span class="hljs-built_in">export</span> INCLUDE=<span class="hljs-variable">$HDF5</span>/include:<span class="hljs-variable">$INCLUDE</span>
<span class="hljs-comment"># source ~/.bashrc</span>
</code></pre>
<h4 id="netcdf-c">NetCDF-C</h4>
<pre><code class="lang-bash">./configure --prefix=&#x4F60;&#x7684;&#x5B89;&#x88C5;&#x8DEF;&#x5F84;/netcdf LDFLAGS=<span class="hljs-string">&quot;-L<span class="hljs-variable">$HDF5</span>/lib&quot;</span> CPPFLAGS=<span class="hljs-string">&quot;-I<span class="hljs-variable">$HDF5</span>/include&quot;</span> CC=mpiicc --disable-dap
make -j 48
make install
</code></pre>
<pre><code class="lang-bash"><span class="hljs-comment"># vi ~/.bashrc</span>
<span class="hljs-built_in">export</span> NETCDF=/usr/<span class="hljs-built_in">local</span>/netcdf
<span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$NETCDF</span>/bin:<span class="hljs-variable">$PATH</span>
<span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$NETCDF</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span>
<span class="hljs-built_in">export</span> INCLUDE=<span class="hljs-variable">$NETCDF</span>/include:<span class="hljs-variable">$INCLUDE</span>
<span class="hljs-comment"># source ~/.bashrc</span>
</code></pre>
<h4 id="netcdf-fortran">NetCDF-Fortran</h4>
<pre><code class="lang-bash">./configure --prefix=&#x4F60;&#x7684;&#x5B89;&#x88C5;&#x8DEF;&#x5F84;/netcdf CPPFLAGS=<span class="hljs-string">&quot;-I<span class="hljs-variable">$HDF5</span>/include -I<span class="hljs-variable">$NETCDF</span>/include&quot;</span> LDFLAGS=<span class="hljs-string">&quot;-L<span class="hljs-variable">$HDF5</span>/lib -L<span class="hljs-variable">$NETCDF</span>/lib&quot;</span> CC=mpiicc FC=mpiif90 F77=mpiif90 <span class="hljs-comment"># &#x4E0E;NetCDF-C&#x5B89;&#x88C5;&#x5728;&#x540C;&#x4E00;&#x76EE;&#x5F55;&#x4E0B;</span>
make -j 48
make install
</code></pre>
<h3 id="advanced-lib">Advanced lib</h3>
<p><a href="https://parallel-netcdf.github.io/" target="_blank">PNetCDF</a> A Parallel I/O Library for NetCDF File Access</p>
<blockquote>
<p>4&#x4E2A;node&#x6709;&#x8D1F;&#x9762;&#x6548;&#x679C;&#xFF0C;&#x9700;&#x8981;8&#x4E2A;node&#x53CA;&#x4EE5;&#x4E0A;&#x624D;&#x4F1A;&#x548C;NertCDF&#x6709;&#x5F02;</p>
</blockquote>
<p><a href="https://imgtu.com/i/WnELTI" target="_blank"><img src="https://z3.ax1x.com/2021/07/15/WnELTI.md.png" alt="pnetcdf.png"></a></p>
<p>&#x5B89;&#x88C5;&#x65B9;&#x6CD5;&#x89C1;&#x5B98;&#x7F51;</p>
<h3 id="main-program">Main Program</h3>
<p>&#x7ECF;&#x8FC7;&#x6D4B;&#x8BD5;&#xFF0C;&#x4F7F;&#x7528;intelMPI&#x4F1A;&#x51FA;&#x73B0;segment fault&#xFF0C;OpenMPI&#x5219;&#x4E0D;&#x4F1A;&#xFF0C;&#x7136;&#x800C;intelMPI&#x597D;&#x50CF;&#x5E76;&#x6CA1;&#x6709;&#x5F88;&#x591A;&#x63D0;&#x9AD8;&#xFF0C;&#x53EF;&#x4EE5;&#x4ECE;stack size&#x7684;&#x89D2;&#x5EA6;&#x5C1D;&#x8BD5;&#x4FEE;&#x6B63;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x3002;</p>
<h4 id="env-setting">env setting</h4>
<pre><code class="lang-bash">intel openmpi hdf5 netcdf
</code></pre>
<h4 id="config-and-build">config and build</h4>
<pre><code class="lang-bash">./configure
</code></pre>
<pre><code class="lang-bash">checking <span class="hljs-keyword">for</span> perl5... no
checking <span class="hljs-keyword">for</span> perl... found /usr/bin/perl (perl)
Will use NETCDF <span class="hljs-keyword">in</span> dir: /global/software/centos-7.x86_64/modules/intel/2020.1.217/netcdf/4.7.4
HDF5 not <span class="hljs-built_in">set</span> <span class="hljs-keyword">in</span> environment. Will configure WRF <span class="hljs-keyword">for</span> use without.
PHDF5 not <span class="hljs-built_in">set</span> <span class="hljs-keyword">in</span> environment. Will configure WRF <span class="hljs-keyword">for</span> use without.
Will use <span class="hljs-string">&apos;time&apos;</span> to report timing information
<span class="hljs-variable">$JASPERLIB</span> or <span class="hljs-variable">$JASPERINC</span> not found <span class="hljs-keyword">in</span> environment, configuring to build without grib2 I/O...
------------------------------------------------------------------------
Please select from among the following Linux x86_64 options:

  1. (serial)   2. (smpar)   3. (dmpar)   4. (dm+sm)   PGI (pgf90/gcc)
  5. (serial)   6. (smpar)   7. (dmpar)   8. (dm+sm)   PGI (pgf90/pgcc): SGI MPT
  9. (serial)  10. (smpar)  11. (dmpar)  12. (dm+sm)   PGI (pgf90/gcc): PGI accelerator
 13. (serial)  14. (smpar)  15. (dmpar)  16. (dm+sm)   INTEL (ifort/icc)
                                         17. (dm+sm)   INTEL (ifort/icc): Xeon Phi (MIC architecture)
 18. (serial)  19. (smpar)  20. (dmpar)  21. (dm+sm)   INTEL (ifort/icc): Xeon (SNB with AVX mods)
 22. (serial)  23. (smpar)  24. (dmpar)  25. (dm+sm)   INTEL (ifort/icc): SGI MPT
 26. (serial)  27. (smpar)  28. (dmpar)  29. (dm+sm)   INTEL (ifort/icc): IBM POE
 30. (serial)               31. (dmpar)                PATHSCALE (pathf90/pathcc)
 32. (serial)  33. (smpar)  34. (dmpar)  35. (dm+sm)   GNU (gfortran/gcc)
 36. (serial)  37. (smpar)  38. (dmpar)  39. (dm+sm)   IBM (xlf90_r/cc_r)
 40. (serial)  41. (smpar)  42. (dmpar)  43. (dm+sm)   PGI (ftn/gcc): Cray XC CLE
 44. (serial)  45. (smpar)  46. (dmpar)  47. (dm+sm)   CRAY CCE (ftn $(NOOMP)/cc): Cray XE and XC
 48. (serial)  49. (smpar)  50. (dmpar)  51. (dm+sm)   INTEL (ftn/icc): Cray XC
 52. (serial)  53. (smpar)  54. (dmpar)  55. (dm+sm)   PGI (pgf90/pgcc)
 56. (serial)  57. (smpar)  58. (dmpar)  59. (dm+sm)   PGI (pgf90/gcc): <span class="hljs-_">-f</span>90=pgf90
 60. (serial)  61. (smpar)  62. (dmpar)  63. (dm+sm)   PGI (pgf90/pgcc): <span class="hljs-_">-f</span>90=pgf90
 64. (serial)  65. (smpar)  66. (dmpar)  67. (dm+sm)   INTEL (ifort/icc): HSW/BDW
 68. (serial)  69. (smpar)  70. (dmpar)  71. (dm+sm)   INTEL (ifort/icc): KNL MIC
 72. (serial)  73. (smpar)  74. (dmpar)  75. (dm+sm)   FUJITSU (frtpx/fccpx): FX10/FX100 SPARC64 IXfx/Xlfx

Enter selection [1-75] :
</code></pre>
<p>dm+sm: OMP+MPI</p>
<pre><code class="lang-bash">./compile -j 6 em_real &gt;&amp; build_wrf.log
tail -15 build_wrf.log
</code></pre>
<h4 id="finish">finish</h4>
<p>&#x6240;&#x6709;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x90FD;&#x5728;<code>run</code>&#x6587;&#x4EF6;&#x5939;&#x4E2D;&#x3002;</p>
<h2 id="run">Run</h2>
<pre><code class="lang-bash"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> ../WRF/run/* ; <span class="hljs-keyword">do</span> ln -sf <span class="hljs-variable">$i</span> $(&#x6570;&#x636E;&#x6240;&#x5728;&#x76EE;&#x5F55;) ; <span class="hljs-keyword">done</span>
</code></pre>
<p><code>namelist.input</code>&#x662F;&#x8F93;&#x5165;&#x6587;&#x4EF6;&#xFF0C;&#x5176;&#x4E2D;&#x6709;&#x4F17;&#x591A;&#x53C2;&#x6570;&#x9700;&#x8981;&#x8BBE;&#x7F6E;&#xFF0C;&#x53EF;&#x4EE5;&#x53C2;&#x8003;<a href="https://esrl.noaa.gov/gsd/wrfportal/namelist_input_options.html" target="_blank"><strong>WRF NAMELIST.INPUT FILE DESCRIPTION</strong></a>&#x3002;</p>
<h3 id="slurm-script">slurm script</h3>
<pre><code class="lang-bash"><span class="hljs-comment">#!/bin/bash -l</span>
<span class="hljs-comment">#SBATCH -N 4</span>
<span class="hljs-comment">#SBATCH --ntasks-per-node=20</span>
<span class="hljs-comment">#SBATCH --cpus-per-task=2</span>
<span class="hljs-comment">#SBATCH --ntasks=80</span>
<span class="hljs-comment">#SBATCH -J wrf3Dom_mpi_80_omp_2</span>
<span class="hljs-comment">#SBATCH -p compute</span>
<span class="hljs-comment">#SBATCH -t 2:00:00</span>
<span class="hljs-comment">#SBATCH -o wrf3Dom-%j.out</span>
sleep 300
module load NiaEnv/2019b
module load intel/2019u4  openmpi/4.0.1
<span class="hljs-comment">#hdf5/1.10.5</span>
<span class="hljs-comment">#module load netcdf/4.6.3</span>

<span class="hljs-built_in">ulimit</span> -c unlimited
<span class="hljs-built_in">ulimit</span> <span class="hljs-_">-s</span> unlimited

module list

<span class="hljs-built_in">export</span> HDF5=/home/l/lcl_uotiscscc/lcl_uotiscsccs1034/scratch/nonspack/hdf5
<span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$HDF5</span>/bin:<span class="hljs-variable">$PATH</span>
<span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$HDF5</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span>
<span class="hljs-built_in">export</span> INCLUDE=<span class="hljs-variable">$HDF5</span>/include:<span class="hljs-variable">$INCLUDE</span>

<span class="hljs-built_in">export</span> NETCDF=/home/l/lcl_uotiscscc/lcl_uotiscsccs1034/scratch/nonspack/netcdf
<span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$NETCDF</span>/bin:<span class="hljs-variable">$PATH</span>
<span class="hljs-built_in">export</span> LD_LIBRARY_PATH=<span class="hljs-variable">$NETCDF</span>/lib:<span class="hljs-variable">$LD_LIBRARY_PATH</span>
<span class="hljs-built_in">export</span> INCLUDE=<span class="hljs-variable">$NETCDF</span>/include:<span class="hljs-variable">$INCLUDE</span>


<span class="hljs-built_in">export</span> KMP_STACKSIZE=20480000000


<span class="hljs-built_in">export</span> OMP_NUM_THREADS=<span class="hljs-variable">$SLURM_CPUS_PER_TASK</span>
<span class="hljs-built_in">cd</span> ~/scratch/pl/orifiles
mpirun -np 80 -cpus-per-rank <span class="hljs-variable">$SLURM_CPUS_PER_TASK</span> ./wrf.exe
</code></pre>
<h2 id="important-notice">Important Notice</h2>
<h3 id="stack-size-and-segment-fault"><code>stack size</code> and <code>segment fault</code></h3>
<p><code>ulimit</code> sets the OS limits for the program.
<code>KMP_STACKSIZE</code> tells the OpenMP implementation about how much stack to actually allocate for each of the stacks. So, depending on your OS defaults you might need both. BTW, you should rather use <code>OMP_STACKSIZE</code> instead, as <code>KMP_STACKSIZE</code> is the environment variable used by the Intel and clang compilers. <code>OMP_STACKSIZE</code> is the standard way of setting the stack size of the OpenMP threads.
Note, that this problem is usually more exposed, as Fortran tends to keep more data on the stack, esp. arrays. Some compilers can move such arrays to the heap automatically, see for instance <code>-heap-arrays</code> for the Intel compiler.</p>
<p>Fortran&#x7684;OMP&#x8FDB;&#x7A0B;&#x4F1A;&#x5728;stack&#x91CC;&#x585E;&#x4E00;&#x5927;&#x5806;&#x4E1C;&#x897F;&#xFF0C;&#x5F88;&#x591A;&#x65F6;&#x5019;&#x4F1A;&#x7206;&#x6808;&#xFF0C;&#x6240;&#x4EE5;&#x4F7F;&#x7528;Fortran&#x548C;OMP&#x7684;&#x5E94;&#x7528;&#x9700;&#x8981;&#x6CE8;&#x610F;<code>export KMP_STACKSIZE=20480000000</code>, &#x800C;&#x4E14;<code>gcc</code>&#x662F;<code>OMP</code>,<code>icc</code>&#x662F;<code>KMP</code>&#x3002;</p>
<h3 id="fortran-and-mpi">Fortran and MPI</h3>
<p>&#x4E0D;&#x77E5;&#x9053;&#x662F;slurm&#x8FD8;&#x662F;Fortran&#x7684;&#x95EE;&#x9898;&#xFF0C;slurm&#x4E0D;&#x80FD;&#x5BF9;Fortran&#x7684;MPI&#x7A0B;&#x5E8F;&#x81EA;&#x52A8;&#x5206;&#x914D;CPU&#x6838;&#x5FC3;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x624B;&#x52A8;&#x8BBE;&#x7F6E;&#xFF0C;</p>
<pre><code class="lang-bash">mpirun -np 16 -cpus-per-rank <span class="hljs-variable">$SLURM_CPUS_PER_TASK</span> ./wrf.exe
</code></pre>
<p>tell mpi how many cpu cores should one mpi rank get for openmp</p>
<h3 id="ipm-report-env-setting">IPM Report env setting</h3>
<p>IPM&#x662F;&#x4E00;&#x4E2A;&#x76D1;&#x63A7;MPI&#x4F7F;&#x7528;&#x7684;profiler&#x3002;&#x4F7F;&#x7528;IPM&#x53EA;&#x9700;&#x8981;perloadIPM&#x7684;lib&#x5C31;&#x53EF;&#x4EE5;&#x4E86;&#x3002;&#x4F46;&#x662F;&#x4E3A;&#x4E86;&#x5B8C;&#x6574;&#x751F;&#x6210;&#x62A5;&#x544A;&#x56FE;&#x7247;&#xFF0C;&#x9700;&#x8981;&#x8BBE;&#x5B9A;&#x4EE5;&#x4E0B;&#x53D8;&#x91CF;</p>
<pre><code class="lang-bash"><span class="hljs-built_in">export</span> IPM_REPORT=full
<span class="hljs-built_in">export</span> IPM_LOG=full
</code></pre>
<p>When using IPM, set above envs to make sure you can get right xml to visualize, or using <a href="https://files.slack.com/files-pri/TAXMW9014-F02586VN27L/download/ipm.ipynb" target="_blank">https://files.slack.com/files-pri/TAXMW9014-F02586VN27L/download/ipm.ipynb</a> to visualize</p>
<h2 id="others">Others</h2>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="CodeChallenge.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: Code Challenge">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"WRF","level":"1.3.2.1.2","depth":4,"next":{"title":"SC","level":"1.3.3","depth":2,"ref":"","articles":[{"title":"SC 21","level":"1.3.3.1","depth":3,"ref":"","articles":[{"title":"Ram B Le","level":"1.3.3.1.1","depth":4,"path":"Apps/SC/SC21/ramBLe.md","ref":"Apps/SC/SC21/ramBLe.md","articles":[]}]},{"title":"SC 20","level":"1.3.3.2","depth":3,"path":"Apps/SC/SC20.md","ref":"Apps/SC/SC20.md","articles":[]}]},"previous":{"title":"Code Challenge","level":"1.3.2.1.1","depth":4,"path":"Apps/ISC/ISC-21/CodeChallenge.md","ref":"Apps/ISC/ISC-21/CodeChallenge.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"Apps/ISC/ISC-21/WRF.md","mtime":"2021-07-22T11:35:46.250Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2021-07-22T11:36:34.752Z"},"basePath":"../../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../../gitbook/gitbook.js"></script>
    <script src="../../../gitbook/theme.js"></script>
    
        
        <script src="../../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

