<!DOCTYPE HTML>
<html lang="cn" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Memory Model - GeekPie_HPC Wiki</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Intro</a></li><li class="chapter-item expanded "><a href="../Algorithm/index.html"><strong aria-hidden="true">2.</strong> Algorithm</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Algorithm/dgemm.html"><strong aria-hidden="true">2.1.</strong> dgemm</a></li><li class="chapter-item expanded "><a href="../Algorithm/fft.html"><strong aria-hidden="true">2.2.</strong> fft</a></li><li class="chapter-item expanded "><a href="../Algorithm/kmer.html"><strong aria-hidden="true">2.3.</strong> Kmer</a></li></ol></li><li class="chapter-item expanded "><a href="../Apps/index.html"><strong aria-hidden="true">3.</strong> Apps</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Apps/ASC/index.html"><strong aria-hidden="true">3.1.</strong> ASC</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Apps/ASC/asc-19/index.html"><strong aria-hidden="true">3.1.1.</strong> Asc 19</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Apps/ASC/asc-19/cesm.html"><strong aria-hidden="true">3.1.1.1.</strong> Cesm</a></li></ol></li><li class="chapter-item expanded "><a href="../Apps/ASC/asc-20/index.html"><strong aria-hidden="true">3.1.2.</strong> Asc 20-21</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Apps/ASC/asc-20/quest.html"><strong aria-hidden="true">3.1.2.1.</strong> Quest</a></li></ol></li><li class="chapter-item expanded "><a href="../Apps/ASC/asc-22/index.html"><strong aria-hidden="true">3.1.3.</strong> Asc 22</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Apps/ASC/asc-22/yuan.html"><strong aria-hidden="true">3.1.3.1.</strong> yuan</a></li><li class="chapter-item expanded "><a href="../Apps/ASC/asc-22/DeepMD.html"><strong aria-hidden="true">3.1.3.2.</strong> DeepMD</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../Apps/ISC/index.html"><strong aria-hidden="true">3.2.</strong> ISC</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Apps/ISC/ISC-21/index.html"><strong aria-hidden="true">3.2.1.</strong> ISC 21</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Apps/ISC/ISC-21/CodeChallenge.html"><strong aria-hidden="true">3.2.1.1.</strong> Code Challenge</a></li><li class="chapter-item expanded "><a href="../Apps/ISC/ISC-21/LAMMPS.html"><strong aria-hidden="true">3.2.1.2.</strong> LAMMPS</a></li><li class="chapter-item expanded "><a href="../Apps/ISC/ISC-21/GPAW.html"><strong aria-hidden="true">3.2.1.3.</strong> GPAW</a></li><li class="chapter-item expanded "><a href="../Apps/ISC/ISC-21/MHM2.html"><strong aria-hidden="true">3.2.1.4.</strong> MHM2</a></li><li class="chapter-item expanded "><a href="../Apps/ISC/ISC-21/WRF.html"><strong aria-hidden="true">3.2.1.5.</strong> WRF</a></li></ol></li><li class="chapter-item expanded "><a href="../Apps/ISC/ISC-22/index.html"><strong aria-hidden="true">3.2.2.</strong> ISC 22</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Apps/ISC/ISC-22/Incompact3D.html"><strong aria-hidden="true">3.2.2.1.</strong> Incompact3D</a></li><li class="chapter-item expanded "><a href="../Apps/ISC/ISC-22/NWChem.html"><strong aria-hidden="true">3.2.2.2.</strong> NWChem</a></li><li class="chapter-item expanded "><a href="../Apps/ISC/ISC-22/ICON.html"><strong aria-hidden="true">3.2.2.3.</strong> ICON</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../Apps/SC/index.html"><strong aria-hidden="true">3.3.</strong> SC</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Apps/SC/IndySC22/index.html"><strong aria-hidden="true">3.3.1.</strong> SC 22</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Apps/SC/IndySC22/MiniVite.html"><strong aria-hidden="true">3.3.1.1.</strong> MiniVite</a></li><li class="chapter-item expanded "><a href="../Apps/SC/IndySC22/HPL.html"><strong aria-hidden="true">3.3.1.2.</strong> HPL</a></li><li class="chapter-item expanded "><a href="../Apps/SC/IndySC22/NAMD.html"><strong aria-hidden="true">3.3.1.3.</strong> NAMD</a></li></ol></li><li class="chapter-item expanded "><a href="../Apps/SC/SC21/index.html"><strong aria-hidden="true">3.3.2.</strong> SC 21</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Apps/SC/SC21/quantum-espresso.html"><strong aria-hidden="true">3.3.2.1.</strong> Quantum Espresso</a></li><li class="chapter-item expanded "><a href="../Apps/SC/SC21/ramBLe.html"><strong aria-hidden="true">3.3.2.2.</strong> Ram B Le</a></li><li class="chapter-item expanded "><a href="../Apps/SC/SC21/cardioid.html"><strong aria-hidden="true">3.3.2.3.</strong> Cardioid</a></li><li class="chapter-item expanded "><a href="../Apps/SC/SC21/Mystery.html"><strong aria-hidden="true">3.3.2.4.</strong> Mystery</a></li></ol></li><li class="chapter-item expanded "><a href="../Apps/SC/SC20.html"><strong aria-hidden="true">3.3.3.</strong> SC 20</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../Benchmark/index.html"><strong aria-hidden="true">4.</strong> Benchmark</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Benchmark/hpcg-dat.html"><strong aria-hidden="true">4.1.</strong> Hpcg Dat</a></li><li class="chapter-item expanded "><a href="../Benchmark/hpl-dat.html"><strong aria-hidden="true">4.2.</strong> Hpl Dat</a></li><li class="chapter-item expanded "><a href="../Benchmark/io500.html"><strong aria-hidden="true">4.3.</strong> Io 500</a></li></ol></li><li class="chapter-item expanded "><a href="../DevOps/index.html"><strong aria-hidden="true">5.</strong> Dev Ops</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../DevOps/beegfs.html"><strong aria-hidden="true">5.1.</strong> BeeGFS</a></li><li class="chapter-item expanded "><a href="../DevOps/Grafana.html"><strong aria-hidden="true">5.2.</strong> Grafana</a></li><li class="chapter-item expanded "><a href="../DevOps/Scheduler.html"><strong aria-hidden="true">5.3.</strong> Scheduler</a></li><li class="chapter-item expanded "><a href="../DevOps/Singularity.html"><strong aria-hidden="true">5.4.</strong> Singularity</a></li><li class="chapter-item expanded "><a href="../DevOps/kanidm.html"><strong aria-hidden="true">5.5.</strong> Kanidm</a></li><li class="chapter-item expanded "><a href="../DevOps/Oracle/index.html"><strong aria-hidden="true">5.6.</strong> Oracle</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../DevOps/Oracle/ansible.html"><strong aria-hidden="true">5.6.1.</strong> Ansible</a></li><li class="chapter-item expanded "><a href="../DevOps/Oracle/grafana.html"><strong aria-hidden="true">5.6.2.</strong> Grafana</a></li></ol></li><li class="chapter-item expanded "><a href="../DevOps/ISC/index.html"><strong aria-hidden="true">5.7.</strong> ISC</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../DevOps/ISC/NSCC.html"><strong aria-hidden="true">5.7.1.</strong> NSCC</a></li><li class="chapter-item expanded "><a href="../DevOps/ISC/Bridges.html"><strong aria-hidden="true">5.7.2.</strong> Bridges</a></li><li class="chapter-item expanded "><a href="../DevOps/ISC/Thor.html"><strong aria-hidden="true">5.7.3.</strong> Thor</a></li><li class="chapter-item expanded "><a href="../DevOps/ISC/Niagara.html"><strong aria-hidden="true">5.7.4.</strong> Niagara</a></li></ol></li><li class="chapter-item expanded "><a href="../DevOps/Azure/index.html"><strong aria-hidden="true">5.8.</strong> Azure</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../DevOps/Azure/cyclecloud.html"><strong aria-hidden="true">5.8.1.</strong> CycleCloud</a></li><li class="chapter-item expanded "><a href="../DevOps/Azure/check-list.html"><strong aria-hidden="true">5.8.2.</strong> Check List</a></li></ol></li><li class="chapter-item expanded "><a href="../DevOps/GeekPie/index.html"><strong aria-hidden="true">5.9.</strong> GeekPie</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../DevOps/GeekPie/hardware.html"><strong aria-hidden="true">5.9.1.</strong> Hardware</a></li><li class="chapter-item expanded "><a href="../DevOps/GeekPie/software.html"><strong aria-hidden="true">5.9.2.</strong> Software</a></li><li class="chapter-item expanded "><a href="../DevOps/GeekPie/tuning.html"><strong aria-hidden="true">5.9.3.</strong> Tuning</a></li><li class="chapter-item expanded "><a href="../DevOps/GeekPie/kernel.html"><strong aria-hidden="true">5.9.4.</strong> Kernel</a></li><li class="chapter-item expanded "><a href="../DevOps/GeekPie/systemd-nspawn.html"><strong aria-hidden="true">5.9.5.</strong> systemd-nspawn</a></li></ol></li><li class="chapter-item expanded "><a href="../devops/archived/index.html"><strong aria-hidden="true">5.10.</strong> Archived</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../devops/archived/cluster-setup.html"><strong aria-hidden="true">5.10.1.</strong> Cluster Setup</a></li><li class="chapter-item expanded "><a href="../devops/archived/environment-installation.html"><strong aria-hidden="true">5.10.2.</strong> Environment Installation</a></li><li class="chapter-item expanded "><a href="../devops/archived/environment-modules.html"><strong aria-hidden="true">5.10.3.</strong> Environment Modules</a></li><li class="chapter-item expanded "><a href="../devops/archived/it-support-machine.html"><strong aria-hidden="true">5.10.4.</strong> It-Support Machine</a></li><li class="chapter-item expanded "><a href="../devops/archived/bmc-reverse.html"><strong aria-hidden="true">5.10.5.</strong> BMC Reverse</a></li><li class="chapter-item expanded "><a href="../devops/archived/saltstack.html"><strong aria-hidden="true">5.10.6.</strong> Salt Stack</a></li><li class="chapter-item expanded "><a href="../devops/archived/ldap.html"><strong aria-hidden="true">5.10.7.</strong> LDAP</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../Language/index.html"><strong aria-hidden="true">6.</strong> Language</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Language/C++.html"><strong aria-hidden="true">6.1.</strong> C++</a></li><li class="chapter-item expanded "><a href="../Language/Chisel.html"><strong aria-hidden="true">6.2.</strong> Chisel</a></li><li class="chapter-item expanded "><a href="../Language/Fortran.html"><strong aria-hidden="true">6.3.</strong> Fortran</a></li><li class="chapter-item expanded "><a href="../Language/Go.html"><strong aria-hidden="true">6.4.</strong> Go</a></li><li class="chapter-item expanded "><a href="../Language/Rust.html"><strong aria-hidden="true">6.5.</strong> Rust</a></li></ol></li><li class="chapter-item expanded "><a href="../Libs/index.html"><strong aria-hidden="true">7.</strong> Libs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Libs/Svml.html"><strong aria-hidden="true">7.1.</strong> Svml</a></li><li class="chapter-item expanded "><a href="../Libs/NumaCTL.html"><strong aria-hidden="true">7.2.</strong> NumaCTL</a></li><li class="chapter-item expanded "><a href="../Libs/Boost.html"><strong aria-hidden="true">7.3.</strong> Boost</a></li></ol></li><li class="chapter-item expanded "><a href="../Profiling/index.html"><strong aria-hidden="true">8.</strong> Profiling</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Profiling/ArmForge.html"><strong aria-hidden="true">8.1.</strong> Arm Forge</a></li><li class="chapter-item expanded "><a href="../Profiling/uProf.html"><strong aria-hidden="true">8.2.</strong> Uprof</a></li><li class="chapter-item expanded "><a href="../Profiling/Vtune.html"><strong aria-hidden="true">8.3.</strong> Vtune</a></li></ol></li><li class="chapter-item expanded "><a href="../Spack/handson.html"><strong aria-hidden="true">9.</strong> Spack</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Spack/package.html"><strong aria-hidden="true">9.1.</strong> package</a></li><li class="chapter-item expanded "><a href="../Spack/handson.html"><strong aria-hidden="true">9.2.</strong> handson</a></li><li class="chapter-item expanded "><a href="../Spack/debug.html"><strong aria-hidden="true">9.3.</strong> debug</a></li></ol></li><li class="chapter-item expanded "><a href="../Architecture/index.html"><strong aria-hidden="true">10.</strong> Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../Architecture/MemoryModel.html" class="active"><strong aria-hidden="true">10.1.</strong> Memory Model</a></li><li class="chapter-item expanded "><a href="../Architecture/SVE.html"><strong aria-hidden="true">10.2.</strong> SVE</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">GeekPie_HPC Wiki</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/geekpiehpc/wiki" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="memory-model"><a class="header" href="#memory-model">Memory Model</a></h1>
<h3 id="memory-coherence"><a class="header" href="#memory-coherence">Memory Coherence</a></h3>
<p><strong>Memory coherence:</strong> a memory system is coherent if any read of a data item returns the most recently written value of that data item.</p>
<h4 id="coherent-memory-system"><a class="header" href="#coherent-memory-system">Coherent memory system:</a></h4>
<ol>
<li>For a memory address wrote by a processor P, the next reads of P should get the written value.</li>
<li>For a memory address wrote by a processor P1, after enough time, another processor P2 can get the value written by P1.</li>
<li>The write operations for one memory address are serialized, so if there are 2 writes to a memory address by any processor, any processor cannot get two results in different order.</li>
</ol>
<p>The coherence model does not define when a wrote by P1 can be read by P2. The memory consistency model is responsible for it.</p>
<h3 id="memory-consistency"><a class="header" href="#memory-consistency">Memory Consistency</a></h3>
<p><strong>Memory consistency:</strong> A memory consistency model for a shared address space specifies constraints on the order in which memory operations must appear to be performed (i.e. to become visible to the processors) with respect to one another.(when a written value will be returned/seen by a read).</p>
<p>The memory consistency model defines the order of operation pairs in <strong>different</strong> addresses.</p>
<h4 id="sequential-consistency-model"><a class="header" href="#sequential-consistency-model">Sequential consistency model</a></h4>
<ol>
<li>In each processor, the read operation should always get the value of the last write operation in program order.</li>
</ol>
<pre><code class="language-pseudocode"># Processor 1
Flag1 = 1
if (Flag2 == 0)
	do sth

# Processor 2
Flag2 = 1
if (Flag1 == 0)
	do sth
</code></pre>
<p>For P1, SC can guarantee that if the value of Flag2 is 0, the write of Flag1 happens before the write and read of P2. So there is at most one processor is in the <code>do sth</code> section (Neither processor failed to get in the critical section is also possible).</p>
<ol start="2">
<li>There is only one order visible to all processors. For two write operations <code>W1, W2</code> (can be done by different processors), each processors should get the same sequence.</li>
</ol>
<pre><code># Processor 1
A = 1

# Processor 2
if (A == 1)
    B = 1

# Processor 3
if (B == 1)
    get(A)
</code></pre>
<p>If P3 gets the <code>B == 1</code>, the value of A must be 1. Since the write sequence seen by P2 is <code>A = 1 -&gt; B = 1</code>.</p>
<p>Sequential consistency can produce non-deterministic results. This is because the sequence of sequential operations between processors can be different during different runs of the program. All memory operations need to happen in the program order.</p>
<h4 id="relaxed-memory-consistency-models"><a class="header" href="#relaxed-memory-consistency-models">Relaxed memory consistency models</a></h4>
<p>Suppose <code>A-&gt;B</code> means for one processor, the operation <code>A</code> is done before operation <code>B</code>.</p>
<p>If <code>W-&gt;R</code> is violated, the order is <strong>Total Store Ordering</strong>. It is used by x86-64 architecture.</p>
<p>If <code>W-&gt;W</code> is violated, the order is Partial Store Ordering.</p>
<p>...</p>
<p>More memory models can be seen from</p>
<p>https://en.wikipedia.org/wiki/Consistency_model</p>
<h4 id="synchronized-with-and-happens-before"><a class="header" href="#synchronized-with-and-happens-before">Synchronized-with and happens-before</a></h4>
<p>The <strong>synchronized-with</strong> relationship is something that you can get only between <strong>suitably tagged</strong> (the default is <code>memory_order_seq_cst</code>, which is a suitable tag) operations on <strong>atomic types</strong> (data structures like mutex contains these atomic types). If A writes on x and B reads on x, there is a synchronizes-with relationship between A and B.</p>
<p>The <strong>happens-before</strong> relationship specifies which operations see the effects of which other operations. For a single thread, the happens-before relationship can be easily determined by the program order. For multi-threading, if operation A on one thread <strong>inter-thread happens-before</strong> operation B on another thread, then A happens-before B. The inter-thread happens-before relies on the synchronizes-with relationship. If operation A in one thread synchronizes-with operation B in another thread, then A inter-thread happens-before B. This relationship is transitive.</p>
<p>These rules means if you make changes in one thread, you need only one synchronizes-with relationship for the data to be visible to subsequent operations on other threads.</p>
<h3 id="c-memory-order"><a class="header" href="#c-memory-order">C++ Memory Order</a></h3>
<p>C++ has 6 memory ordering options on atomic types.</p>
<pre><code>momory_order_relaxed,
memory_order_consume,
memory_order_acquire,
memory_order_release,
memory_order_acq_rel,
memory_order_seq_cst.
</code></pre>
<p>They represents 3 memory models:</p>
<pre><code>Sequential Consistency (memory_order_seq_cst)
Relaxed (memory_order_relaxed)
Acquire-Release (memory_order_consume, memory_order_acquire, memory_order_release, memory_order_acq_rel)
</code></pre>
<p>For x86-64 architecture, the acquire-release ordering do not require additional instructions. Sequential consistent ordering has small additional cost on store operations. But it will also influence the instruction reordering of compiler, so they all have potential cost except <code>memory_order_relaxed</code>.</p>
<p>In non-sequentially consistent memory orderings, <strong>threads don’t have to agree on the order of events on atomic variables</strong>. <strong>In the absence of other ordering constraints, the only requirement is that all threads agree on the modification order of each individual variable.</strong></p>
<h4 id="stdmemory_order_seq_cst"><a class="header" href="#stdmemory_order_seq_cst">std::memory_order_seq_cst</a></h4>
<blockquote>
<p>If all operations on instances of atomic types are sequentially consistent, the behavior of a multithreaded program is as if all these operations were performed in some particular sequence by a single thread. This is by far the easiest memory ordering to understand, which is why it’s the default: all threads must see the same order of operations. ... It also means that operations can’t be reordered; if your code has one operation before another in one thread, that ordering must be seen by all other threads.</p>
<p>A sequentially consistent store <strong>synchronizes-with</strong> a sequentially consistent load of the same variable that reads the value stored.</p>
<p>-- <em>C++ concurrency in action 2nd edition, P124</em>  </p>
</blockquote>
<h4 id="stdmemory_order_relaxed"><a class="header" href="#stdmemory_order_relaxed">std::memory_order_relaxed</a></h4>
<blockquote>
<p>Operations on atomic types performed with relaxed ordering don’t participate in synchronizes-with relationships. Operations on the same variable within a single thread still obey happens-before relationships, but there’s almost no requirement on ordering relative to other threads.</p>
<p>-- <em>C++ concurrency in action 2nd edition, P127</em></p>
</blockquote>
<pre><code class="language-c++"># Processor 1
x.store(true, std::memory_order_relaxed);
y.store(true, std::memory_order_relaxed);

# Processor 2
while (!y.load(std::memory_order_relaxed));
if (x.load(std::memory_order_relaxed)) ++z;
</code></pre>
<p>Here z can be 0. Since there are no ordering guarantees relating to the visibility to different threads.</p>
<p>The relaxed ordering gives a well-defined behavior in multi-threading compared to <code>volatile</code> keyword or only uses a normal variable. Since the sematic is <strong>atomic</strong>, the <code>fetch_add</code> method is also atomic, which means you can use it as a counter. In x86, the <code>fetch_add</code> method with <code>std::memory_order_relaxed</code> is implemented as <code>lock xadd</code>, which is same as using <code>std::memory_order_seq_cst</code> (but the former one can be reordered by the compiler, and in other architectures, the implementation may be different).</p>
<p>Problem may encounter in using relaxed ordering: OOTA</p>
<p>http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2019/p1217r2.html</p>
<h4 id="stdmemory_order_acquire--stdmemory_order_release"><a class="header" href="#stdmemory_order_acquire--stdmemory_order_release">std::memory_order_acquire &amp;&amp; std::memory_order_release</a></h4>
<p>std::memory_order_release only used in <code>store()</code>, std::memory_order_acquire only used in <code>load()</code>. The operation pair can form a <strong>synchronizes-with</strong> relationship.</p>
<ul>
<li>Any writes or reads before <code>store()</code> should not be moved after it.</li>
<li>Any writes or reads after <code>load()</code> should not be moved before it.</li>
</ul>
<p>Typical usage:</p>
<pre><code class="language-c++"># Processor 1
data = 100;                                       // A
ready.store(true, std::memory_order_release);     // B

# Processor 2
while (!ready.load(std::memory_order_acquire))    // C
    ;
assert(data == 100); // never failed              // D
</code></pre>
<p>TODO: std::memory_order_consume</p>
<h4 id="double-checking-locking"><a class="header" href="#double-checking-locking">Double-checking locking</a></h4>
<pre><code class="language-c++">if (!x_init.load(memory_order_acquire)) {
    lock_guard&lt;mutex&gt; _(x_init_mutex);
    if (!x_init.load(memory_order_relaxed)) { // &lt;- Already hold the lock!
        initialize x;
        x_init.store(true, memory_order_release);
    }
}
</code></pre>
<h4 id="initial-load-for-compare-exchange"><a class="header" href="#initial-load-for-compare-exchange">Initial load for compare-exchange</a></h4>
<pre><code class="language-c++">unsigned long expected = x.load(memory_order_relaxed); 
// &lt;- result does not affect correctness since the CAS will check again. 
while (!x.compare_exchange_weak(expected, f(expected))) {}
</code></pre>
<p>References:</p>
<ul>
<li>[1] <a href="https://www.manning.com/books/c-plus-plus-concurrency-in-action-second-edition">C++ concurrency in action, 2nd edition</a></li>
<li>[2] <a href="http://senlinzhan.github.io/2017/12/04/cpp-memory-order/">理解 C++ 的 Memory Order</a></li>
<li>[3] <a href="https://www.cl.cam.ac.uk/~pes20/weakmemory/cacm.pdf">x86-TSO: A Rigorous and Usable Programmer’s Model for x86 Multiprocessors</a></li>
<li>[4] <a href="https://www.kernel.org/doc/Documentation/memory-barriers.txt">Linux kernel memory barriers document</a></li>
<li>[5] <a href="https://www.youtube.com/watch?v=cWkUqK71DZ0">A Relaxed Guide to memory_order_relaxed - Paul E. McKenney &amp; Hans Boehm - CppCon 2020</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../Architecture/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../Architecture/SVE.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../Architecture/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../Architecture/SVE.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
